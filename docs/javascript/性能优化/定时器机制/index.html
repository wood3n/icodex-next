<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-javascript/性能优化/定时器机制">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">定时器 | icodex</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://icodex.me/docs/javascript/性能优化/定时器机制"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="keywords" content="frontend, react, javascript, css, react, vue, typescript, docusaurus, blog, personal blog, personal website"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="定时器 | icodex"><meta data-rh="true" name="description" content="Timers"><meta data-rh="true" property="og:description" content="Timers"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://icodex.me/docs/javascript/性能优化/定时器机制"><link data-rh="true" rel="alternate" href="https://icodex.me/docs/javascript/性能优化/定时器机制" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://icodex.me/docs/javascript/性能优化/定时器机制" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GMKEEJO8X4-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="icodex RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="icodex Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-153188913-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-153188913-1",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="icodex" href="/opensearch.xml">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.596c1d98.css">
<link rel="preload" href="/assets/js/runtime~main.37c10f68.js" as="script">
<link rel="preload" href="/assets/js/main.777d231b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="icodex" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="icodex" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">icodex</b></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a class="navbar__item navbar__link" href="/pages/project">My Project</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Skill</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/javascript/guides">JavaScript</a></li><li><a class="dropdown__link" href="/docs/css/guides">CSS</a></li><li><a class="dropdown__link" href="/docs/typescript">TypeScript</a></li><li><a class="dropdown__link" href="/docs/react/guides">React</a></li><li><a class="dropdown__link" href="/docs/nodejs/awesome-nodejs">NodeJS</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/network/guides">Network</a></li><li><a class="dropdown__link" href="/docs/algorithm/算法分析">Algorithm</a></li><li><a class="dropdown__link" href="/docs/interview/guides">Interview</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/engineer/guides">Engineer</a><a class="navbar__item navbar__link" href="/docs/tools/git">Tool</a><a href="https://github.com/wood3n/icodex-next" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="icodex" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="icodex" class="themedImage_ToTc themedImage--dark_i4oU"><b>icodex</b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/docs/javascript/guides">JavaScript</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/类型">类型</a><button aria-label="打开/收起侧边栏菜单「类型」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/string">String</a><button aria-label="打开/收起侧边栏菜单「String」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/number">Number</a><button aria-label="打开/收起侧边栏菜单「Number」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/regexp">RegExp</a><button aria-label="打开/收起侧边栏菜单「RegExp」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/date">Date</a><button aria-label="打开/收起侧边栏菜单「Date」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/object">Object</a><button aria-label="打开/收起侧边栏菜单「Object」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/函数">函数</a><button aria-label="打开/收起侧边栏菜单「函数」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/dom">DOM</a><button aria-label="打开/收起侧边栏菜单「DOM」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/runtime">Runtime</a><button aria-label="打开/收起侧边栏菜单「Runtime」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/性能优化">性能优化</a><button aria-label="打开/收起侧边栏菜单「性能优化」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/javascript/性能优化/定时器机制">定时器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/javascript/性能优化/防抖和节流">防抖和节流</a></li></ul></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/javascript/guides"><span itemprop="name">JavaScript</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/性能优化"><span itemprop="name">性能优化</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">定时器</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>定时器</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="timers">Timers<a class="hash-link" href="#timers" title="标题的直接链接">​</a></h2><blockquote><p><a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers" target="_blank" rel="noopener noreferrer">Timers</a></p></blockquote><p>诸如<code>setTimeout</code>，<code>setInterval</code>属于定时器类型的任务类型，在页面事件循环的机制中，定时器类型的任务最终也会被放到任务队列中去处理。</p><p>从 whatwg 规范定义的内容来看，无论是<code>setTimeout</code>还是<code>setInterval</code>都会经过一个初始化定时器的步骤，并且它们俩用的都是同一套算法，同一个定时器任务列表，见 —— <a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timer-initialisation-steps" target="_blank" rel="noopener noreferrer">timer-initialisation-steps</a>，大致的步骤如下：</p><ul><li><p>如果提供了<code>previous handle</code>，则让当前定时任务的<code>handle</code>（<code>handle</code>就是当前定时任务的 Id）等于<code>previous handle</code>；如果没有，取一个大于 0 的整数来作为<code>handle</code>，并在定时器任务列表（<strong>list of active timers</strong>）中添加一条记录；</p></li><li><p>准备将回调函数执行封装成一个任务：</p><ul><li>如果当前定时器任务列表中此<code>handle</code>的任务已经被清除，那么就终止算法过程；</li><li>在任务中调用回调函数</li><li>判断当前重复执行的标记位（repeat flag），如果为 true 则回头调用这个算法；</li></ul></li><li><p>设置<code>timeout</code></p></li><li><p>判断任务队列中<code>currently running task</code>是否是之前设定过的定时任务，如果是的话设置嵌套级别<code>nesting level</code>等于<code>currently running task</code>的<code>timer nesting level</code>，如果不是则设置嵌套级别<code>nesting level</code>等于 0；</p></li><li><p>如果<code>timeout</code>小于 0，设置<code>timeout</code>等于 0；如果嵌套级别<code>nesting level</code>大于 5，设置<code>timeout</code>等于 4</p></li><li><p>让<code>nesting level += 1</code>；</p></li><li><p>让当前定时任务的<code>timer nesting level</code> 等于<code>nesting level</code>；</p></li><li><p>返回<code>handle</code>，然后继续<strong>并行运行此算法</strong>；</p></li><li><p>等待延迟时间结束，将定时任务排列到任务队列中去执行。</p></li></ul><p>从浏览器引擎的角度来看，实际上还会存在一种延迟执行的任务队列<a href="https://source.chromium.org/chromium/chromium/src/+/master:base/task/sequence_manager/task_queue_impl.h;bpv=1;bpt=1;l=308?gsn=DelayedIncomingQueue&amp;gs=kythe%3A%2F%2Fchromium.googlesource.com%2Fchromium%2Fsrc%3Flang%3Dc%2B%2B%3Fpath%3Dsrc%2Fbase%2Ftask%2Fsequence_manager%2Ftask_queue_impl.h%23RkefcvcqCdse2BLt2fciB2l5hG6ZWMxHY9xBzquPyXE" target="_blank" rel="noopener noreferrer">DelayedIncomingQueue</a>，用于保存定时器任务。主线程在执行 JS 的过程中如果遇到<code>setTimeout</code>之类的定时器，会根据其回调函数和当前发起<code>setTimeout</code>的时间，以及延迟执行的时间去创建一个回调任务，保存到延迟执行的任务队列中，然后继续执行当前任务。在等待<code>setTimeout</code>中设置的延迟以后，就会将延迟队列中的任务取出并添加到任务队列中去等待执行。</p><p>如果在延迟队列中的任务尚未执行，可以使用<code>clearTimeout</code>从延迟队列中删除任务。</p><p><img loading="lazy" alt="image-20200821182409351" src="/assets/images/image-20200821182409351-16412000000497-8ea567c52c11072b9f4f9b174208b8cc.png" width="1185" height="609" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="in-parallel">in parallel<a class="hash-link" href="#in-parallel" title="标题的直接链接">​</a></h3><blockquote><p><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" target="_blank" rel="noopener noreferrer">whatwg - in-parallel</a></p></blockquote><p>并行运行指的是，某一个算法与规范中定义的其它算法会同时运行，而不是算法中的步骤会并行运行，算法中的步骤仍然会一个接一个地按顺序执行。相比之下，要立即运行的操作必须中断任务队列中的 currently running task，先执行它，然后再恢复之前的 currently running task。</p><p>为了避免不同的并行运行的算法在操作相同数据时发生竞争关系（ race conditions ），会使用一个并行队列。并行队列具有一个算法队列，算法队列中的步骤必须连续一个接一个的按顺序执行。</p><p>将执行步骤放入并行队列中，就是将步骤排列到算法队列中去执行。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="settimeout">setTimeout<a class="hash-link" href="#settimeout" title="标题的直接链接">​</a></h3><blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout" target="_blank" rel="noopener noreferrer">MDN - setTimeout</a></p></blockquote><p><code>setTimeout</code>的语法有两种：</p><blockquote><p><code>setTimeout(handler, timeout, [arguments... ])</code></p><p>handler：回调函数</p><p>timeout：毫秒数</p><p>arguments：传递给 handler function 的参数</p><p>返回一个正整数，表示当前计时器的 Id，可以使用<code>clearTimeout()</code>方法来根据 Id 清除某个计时器</p></blockquote><blockquote><p><code>setTimeout(code, timeout)</code></p><p>code： 一串代码字符串</p><p>timeout：毫秒数</p><p>不推荐这种形式的回调，一方面，字符串形式的代码需要二次解析成可执行代码，另一方面，这种形式容易带来和<code>eval()</code>一样的安全风险</p></blockquote><p>关于<code>setTimeout</code>需要注意以下几点：</p><ul><li>timeout 是毫秒数，也就是秒乘以 1000，并且当 timeout 设置小于 0 时，会被按照 0 处理；</li><li>timeout 设置的延迟时间不是经过该时间就精确执行的时间，要算上 CPU 延迟和任务队列等待执行任务的时间；也就是设置 timeout = 0，也还是会导致其一定程度的延迟执行；</li><li>根据 whatwg 规范的定义，<code>setTimeout</code>可以嵌套调用，但是当嵌套五次以后，执行回调的间隔时间将会被节流到至少 4ms，见 —— <a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers" target="_blank" rel="noopener noreferrer">whatwg - timers</a>部分的 Note；</li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20200820161521104" src="/assets/images/image-20200820161521104-164111526865021-997bbf65c3e8d57ac5099c630b98a7e4.png" width="1104" height="303" class="img_ev3q"></p><ul><li>而对于未激活的浏览器标签页面内的定时器，也将会被节流，最小执行回调的间隔时间为 1000ms；</li><li>延迟执行时间的保存使用 32 个 bit 来存储，其中还有一个符号位，也就是延迟执行的最大设置时间只能到 2^31 - 1 = <code>2147483647</code>ms，如果超过这个时间，就相当于是 0 来看待；</li><li>最后值得注意的就是在<code>setTimeout</code>中传入的回调函数会发生<code>this</code>指向变化的问题，这个在作用域的介绍里已经解释过了，一般解决方式是使用箭头函数或者使用<code>bind</code>。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="用-settimeout-实现-setinterval">用 setTimeout 实现 setInterval<a class="hash-link" href="#用-settimeout-实现-setinterval" title="标题的直接链接">​</a></h3><p>上文说过，<code>setTimeout</code>和<code>setInterval</code>用的是同一个<strong>list of active timers</strong>，并且算法步骤也基本一样。所以完全可以用<code>setTimeout</code>实现一个<code>setInterval</code>，一般来说，很容易想到递归的方式，即在<code>setTimeout</code>回调中再次调用函数：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_setInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">fn</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_setInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">_setInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是这种方式设置的<code>setInterval</code>没法清除啊，这往下走肯定奔着内存泄漏去了，可以利用 Chromium 那个延迟队列的方式来做：</p><ul><li>创建一个数组用来保存 interval 的任务；</li><li>每次使用<code>setTimeout</code>来创建延迟任务的时候，先检查数组中是否存在当前 interval 的 Id，如果存在就设置定时任务，并且在回调中再次调用<code>setTimeout</code>创建下一个定时任务；</li><li>根据 Id 清除<code>setInterval</code>任务的时候，删除数组中相应的元素即可；</li><li>最后设置<code>setInterval</code>的时候，需要最后更新一下全局 interval 的 Id，这样保证下一次设置的<code>setInterval</code>不会重复</li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> delayStack </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_setInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">fn</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> intervalId </span><span class="token operator">=</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> interval </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token plain"> intervalId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">func</span><span class="token operator">:</span><span class="token plain"> fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  delayStack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">interval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">_fn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">delayStack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">find</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">item</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> intervalId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">_fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">_fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  id</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_clearInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">clearId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> delayStack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">findIndex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">item</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> clearId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  delayStack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">splice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="requestanimationframe">requestAnimationFrame<a class="hash-link" href="#requestanimationframe" title="标题的直接链接">​</a></h2><p>在过去 CSS 还不是太牛逼的时候，可以利用 JS 的<code>setTimeout</code>或者<code>setInterval</code>来做动画。但是<code>setTimeout</code>等定时器受限于浏览器处理任务的事件循环机制，也就是定时结束的回调函数只是推入任务队列等待执行，而不是定时结束立即执行。举个例子，定时器计算时间期间，页面又触发了大量 DOM 回调事件，那么定时器回调函数就可能在 DOM 响应后执行。</p><p>同时，大多数普通显示器的屏幕刷新率都在 60Hz，也就是每秒呈现 60 帧画面，可以计算出每帧画面的间隔时间为：</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1000</mn><mi>m</mi><mi>s</mi><mi mathvariant="normal">/</mi><mn>60</mn><mo>=</mo><mn>16.66666</mn><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">1000ms / 60 = 16.66666ms</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord">6</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span><span class="mord">6</span><span class="mord">.</span><span class="mord">6</span><span class="mord">6</span><span class="mord">6</span><span class="mord">6</span><span class="mord">6</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span></span></div><p>也就是显示器在绘制出上一帧画面之后，最快需要经过上面的时间间隔才能绘制呈现下面的一帧画面。而即使将<code>setTimeout</code>的时间设置为<code>16.66</code>，也无法保证跟上屏幕刷新的速度，这就导致动画掉帧的情况。</p><p><code>requestAnimationFrame</code>是 HTML 规范定义的 API，用于跟随屏幕刷新率定时执行回调函数，可用于制作性能要求高的动画效果。</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> animationId </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">requestAnimationFrame</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter literal-property property">timeStamp</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMHighResTimeStamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">//...再次调用 requestAnimationFrame</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">cancelAnimationFrame</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">animationId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>requestAnimationFrame</code>方法只有一个参数，是传入一个回调函数，该回调函数会接受一个双精度时间戳数字<code>DOMHighResTimeStamp</code>作为参数，表示调用当前回调函数时一个精确的时间值；该时间戳的精度值可以精确到 5μs（微秒）。</p><p><img loading="lazy" alt="image-20200824171500907" src="data:image/png;base64,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" width="260" height="155" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="机制">机制<a class="hash-link" href="#机制" title="标题的直接链接">​</a></h3><p>在事件循环的机制中，<code>requestAnimationFrame</code>的回调函数会在当前任务以及微任务都执行完，并且准确下一帧动画渲染之前被调用，所以<code>requestAnimationFrame</code>总能保证每次执行回调函数的时间间隔和浏览器的刷新频率保持一致，从此不用担心应该为动画间隔指定多少延迟时间而感到焦虑了。</p><p>从 whatwg 的规范来看，每一个页面实际上有一个<code>map</code>结构用来保存每次通过<code>requestAnimationFrame</code>设置的回调函数，见 —— <a href="https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#dom-animationframeprovider-requestanimationframe" target="_blank" rel="noopener noreferrer"><strong>run requestAnimationFrame</strong></a>，而到事件循环机制中去需要去执行<code>requestAnimationFrame</code>设置的回调函数的时候，会遍历<code>map</code>，取出回调函数执行，见 —— <a href="https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#run-the-animation-frame-callbacks" target="_blank" rel="noopener noreferrer"><strong>run the animation frame callback</strong></a>。</p><p>下面这段程序设置在页面中从左往右移动 200px，动画时间 2s，速度<code>0.1px/ms</code>。</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&lt;</span><span class="token plain">div id</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app&quot;</span><span class="token plain"> style</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;width: 100px; height: 100px; background: red&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">document</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getElementById</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;app&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> previousTimeStamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> done </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">step</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">timestamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">start </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    start </span><span class="token operator">=</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> elapsed </span><span class="token operator">=</span><span class="token plain"> timestamp </span><span class="token operator">-</span><span class="token plain"> start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">previousTimeStamp </span><span class="token operator">!==</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Math.min() is used here to make sure the element stops at exactly 200px</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0.1</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> elapsed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    element</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">transform</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;translateX(&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;px)&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> done </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">elapsed </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">2000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Stop the animation after 2 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    previousTimeStamp </span><span class="token operator">=</span><span class="token plain"> timestamp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">!</span><span class="token plain">done </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">requestAnimationFrame</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">step</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">window</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">requestAnimationFrame</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">step</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/wood3n/icodex-next/tree/master/docs/javascript/性能优化/定时器机制.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/性能优化"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">性能优化</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/javascript/性能优化/防抖和节流"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">防抖和节流</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#timers" class="table-of-contents__link toc-highlight">Timers</a><ul><li><a href="#in-parallel" class="table-of-contents__link toc-highlight">in parallel</a></li><li><a href="#settimeout" class="table-of-contents__link toc-highlight">setTimeout</a></li><li><a href="#用-settimeout-实现-setinterval" class="table-of-contents__link toc-highlight">用 setTimeout 实现 setInterval</a></li></ul></li><li><a href="#requestanimationframe" class="table-of-contents__link toc-highlight">requestAnimationFrame</a><ul><li><a href="#机制" class="table-of-contents__link toc-highlight">机制</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.37c10f68.js"></script>
<script src="/assets/js/main.777d231b.js"></script>
</body>
</html>